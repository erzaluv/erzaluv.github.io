<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сбор объектов в A-Frame</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-physics-system/master/dist/aframe-physics-system.min.js"></script>
    <style>
        body { margin: 0; }
        #game-over { position: absolute; top: 20px; left: 20px; color: white; display: none; }
    </style>
</head>
<body>

<div id="game-over">
    <h1>Игра окончена!</h1>
    <h2>Ваш счет: <span id="final-score">0</span></h2>
    <button id="restart-btn">Перезапустить игру</button>
</div>

<a-scene physics="debug: true">
    <a-sky src="url(https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg)"></a-sky>
    <a-plane rotation="-90 0 0" width="100" height="100" color="#7BC8A4" static-body></a-plane>

    <!-- Игрок -->
    <a-entity id="player" position="0 1.6 0" camera look-controls dynamic-body>
        <a-cursor color="red"></a-cursor>
        <a-entity position="0 -0.5 0" geometry="primitive: ring; radiusInner: 0.1; radiusOuter: 0.2" material="color: red"></a-entity>
    </a-entity>

    <!-- Объекты для сбора -->
    <a-sphere position="-3 0.5 -5" radius="0.5" color="#EF2D5E" class="collectible" dynamic-body></a-sphere>
    <a-sphere position="2 0.5 -3" radius="0.5" color="#4CC3D9" class="collectible" dynamic-body></a-sphere>
    <a-sphere position="0 0.5 -8" radius="0.5" color="#FFC65D" class="collectible" dynamic-body></a-sphere>
    <a-sphere position="-5 0.5 -10" radius="0.5" color="#FF5733" class="collectible" dynamic-body></a-sphere>
    <a-sphere position="4 0.5 -7" radius="0.5" color="#C70039" class="collectible" dynamic-body></a-sphere>
    <a-sphere position="-2 0.5 -12" radius="0.5" color="#900C3F" class="collectible" dynamic-body></a-sphere>
    <a-sphere position="3 0.5 -4" radius="0.5" color="#581845" class="collectible" dynamic-body></a-sphere>

    <!-- Текст для счета и таймера -->
    <a-text id="score-text" value="Score: 0" position="-1 4 -4.1" color="#FFF"></a-text>
    <a-text id="timer-text" value="Время: 30" position="2 4 -4.1" color="#FFF"></a-text>

    <!-- Звук при сборе -->
    <a-sound src="yoursound.wav" autoplay="false" id="collectSound"></a-sound>

    <!-- Движущиеся объекты -->
    <a-entity id="movingObj" geometry="primitive: cone" material="color: red"
              position="0 2 -8"
              animation="property: position; to: 5 2 -8; dur: 2000; loop: true">
    </a-entity>

</a-scene>

<script>
let score = 0;
let timer = 30;
let gameOver = false;

const scoreText = document.getElementById('score-text');
const timerText = document.getElementById('timer-text');
const collectibles = document.querySelectorAll('.collectible');

function checkForCollectibles() {
    collectibles.forEach(collectible => {
        const collectiblePosition = collectible.object3D.position;
        const playerPosition = document.getElementById('player').object3D.position;

        const distance = collectiblePosition.distanceTo(playerPosition);
        if (distance < 1) {
            collectible.parentNode.removeChild(collectible);
            score++;
            scoreText.setAttribute('value', `Score: ${score}`);
            // Воспроизведение звука при сборе
            document.querySelector('#collectSound').components.sound.playSound();
        }
    });

    // Проверка на окончание игры
    if (score >= collectibles.length) {
        endGame();
    }
}

const countdown = setInterval(() => {
    if (timer > 0 && !gameOver) {
        timer--;
        timerText.setAttribute('value', `Время: ${timer}`);
        checkForCollectibles();
    } else if (timer === 0 && !gameOver) {
        endGame();
    }
}, 1000);

function endGame() {
    gameOver = true;
    clearInterval(countdown);
    document.getElementById('final-score').innerText = score;
    document.getElementById('game-over').style.display = 'block';
    
    // Отключаем управление игроком
    document.getElementById('player').setAttribute('dynamic-body', 'mass: 0'); // Отключение физики
}

document.getElementById('restart-btn').addEventListener('click', () => {
    location.reload();
});

const playerEntity = document.getElementById('player');

function movePlayer(controller) {
    const controllerPosition = controller.object3D.position;
    
    playerEntity.setAttribute('position', {
        x: controllerPosition.x,
        y: playerEntity.object3D.position.y,
        z: controllerPosition.z
    });

    checkForCollectibles();
}

// Добавляем обработчики событий для контроллеров
const rightController = document.querySelector('#right-hand');
const leftController = document.querySelector('#left-hand');

rightController.addEventListener('selectstart', () => movePlayer(rightController));
leftController.addEventListener('selectstart', () => movePlayer(leftController));

// Функция для рандомизации позиций при перезапуске
function spawnObjects() {
    const positions = [];
    
    for (let i = 0; i < collectibles.length; i++) {
        const x = Math.random() * 10 - 5;
        const z = Math.random() * 10 - 5;
        
        collectibles[i].setAttribute('position', {x, y: 0.5, z});
        positions.push({x, y: 1, z});
    }
}

// Вызываем spawnObjects при перезапуске игры
document.getElementById('restart-btn').addEventListener('click', () => {
   spawnObjects();
   location.reload();
});

// Добавление гравитации
AFRAME.registerComponent('gravity', {
   tick: function () {
       this.el.body.applyForce(0, -9.8, 0);
   }
});

// Применение гравитации к игроку
playerEntity.setAttribute('gravity', '');
</script>

</body>
</html>
