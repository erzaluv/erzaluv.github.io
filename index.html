<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сбор объектов в A-Frame</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-physics-system/master/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-animation-component@3.2.5/dist/aframe-animation-component.min.js"></script>
    <style>
        body { margin: 0; }
        #game-over { position: absolute; top: 20px; left: 20px; color: white; display: none; }
    </style>
</head>
<body>

<div id="game-over">
    <h1>Игра окончена!</h1>
    <h2>Ваш счет: <span id="final-score">0</span></h2>
    <button id="restart-btn">Перезапустить игру</button>
</div>

<a-scene physics="debug: true">
    <a-sky src="url(https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg)"></a-sky>
    <a-plane rotation="-90 0 0" width="100" height="100" color="#7BC8A4" static-body></a-plane>

    <!-- Игрок -->
    <a-entity id="player" position="0 1.6 0" camera look-controls dynamic-body>
        <a-cursor color="red"></a-cursor>
        <a-entity position="0 -0.5 0" geometry="primitive: ring; radiusInner: 0.1; radiusOuter: 0.2" material="color: red"></a-entity>
    </a-entity>

    <!-- Объекты для сбора -->
    <!-- Объекты будут создаваться динамически через JavaScript -->

    <!-- Текст для счета и таймера -->
    <a-text id="score-text" value="Score: 0" position="-1 4 -4.1" color="#FFF"></a-text>
    <a-text id="timer-text" value="Время: 30" position="2 4 -4.1" color="#FFF"></a-text>

    <!-- Звук при сборе -->
    <a-sound src="yoursound.wav" autoplay="false" id="collectSound"></a-sound>

</a-scene>

<script>
let score = 0;
let timer = 30;
let gameOver = false;

const scoreText = document.getElementById('score-text');
const timerText = document.getElementById('timer-text');
const collectibles = [];

function createCollectible(position) {
    const collectible = document.createElement('a-sphere');
    collectible.setAttribute('position', position);
    collectible.setAttribute('radius', '0.5');
    
    // Задаем случайный цвет
    const colors = ['#EF2D5E', '#4CC3D9', '#FFC65D', '#FF5733', '#C70039', '#900C3F', '#581845'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    collectible.setAttribute('color', randomColor);
    collectible.setAttribute('class', 'collectible');
    collectible.setAttribute('dynamic-body', '');
    
    // Добавление анимации
    collectible.setAttribute('animation__scale', 'property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 500; loop: true');

    document.querySelector('a-scene').appendChild(collectible);
}

function spawnObjects() {
   for (let i = 0; i < 6; i++) {
       const x = Math.random() * 10 - 5;
       const z = Math.random() * -15; // Ограничиваем по оси Z
       createCollectible({ x, y: 0.5, z });
   }
}

// Инициализация объектов при загрузке страницы
spawnObjects();

function checkForCollectibles() {
   const collectibleElements = document.querySelectorAll('.collectible');
   collectibleElements.forEach(collectible => {
       const collectiblePosition = collectible.object3D.position;
       const playerPosition = document.getElementById('player').object3D.position;

       const distance = collectiblePosition.distanceTo(playerPosition);
       if (distance < 1) {
           collectible.parentNode.removeChild(collectible);
           score++;
           scoreText.setAttribute('value', `Score: ${score}`);
           // Воспроизведение звука при сборе
           document.querySelector('#collectSound').components.sound.playSound();
       }
   });

   // Проверка на окончание игры
   if (score >= collectibles.length) {
       endGame();
   }
}

const countdown = setInterval(() => {
   if (timer > 0 && !gameOver) {
       timer--;
       timerText.setAttribute('value', `Время: ${timer}`);
       checkForCollectibles();
   } else if (timer === 0 && !gameOver) {
       endGame();
   }
}, 1000);

function endGame() {
   gameOver = true;
   clearInterval(countdown);
   document.getElementById('final-score').innerText = score;
   document.getElementById('game-over').style.display = 'block';
   
   // Отключаем управление игроком
   document.getElementById('player').setAttribute('dynamic-body', 'mass: 0'); // Отключение физики
}

document.getElementById('restart-btn').addEventListener('click', () => {
   location.reload();
});

const playerEntity = document.getElementById('player');

// Функция для передвижения игрока с помощью клавиатуры
function movePlayer(event) {
   if (gameOver) return;

   const movementSpeed = 0.1;
   const playerPosition = playerEntity.object3D.position;

   switch(event.key) {
       case 'w': // Вперед
           playerEntity.setAttribute('position', { x: playerPosition.x, y: playerPosition.y, z: playerPosition.z - movementSpeed });
           break;
       case 's': // Назад
           playerEntity.setAttribute('position', { x: playerPosition.x, y: playerPosition.y, z: playerPosition.z + movementSpeed });
           break;
       case 'a': // Влево
           playerEntity.setAttribute('position', { x: playerPosition.x - movementSpeed, y: playerPosition.y, z: playerPosition.z });
           break;
       case 'd': // Вправо
           playerEntity.setAttribute('position', { x: playerPosition.x + movementSpeed, y: playerPosition.y, z: playerPosition.z });
           break;
   }

   checkForCollectibles();
}

// Добавляем обработчик событий для клавиатуры
window.addEventListener('keydown', movePlayer);

// Добавление гравитации
AFRAME.registerComponent('gravity', {
   tick: function () {
       this.el.body.applyForce(0, -9.8, 0);
   }
});

// Применение гравитации к игроку
playerEntity.setAttribute('gravity', '');
</script>

</body>
</html>
